<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bible Reference Launcher</title>
<style>
    :root{
      --notion-serif: Lyon-Text, Georgia, YuMincho, "Yu Mincho", "Hiragino Mincho ProN", "Hiragino Mincho Pro", "Songti TC", "Songti SC", SimSun, "Nanum Myeongjo", NanumMyeongjo, Batang, serif;
    }

    body {
      font-family: var(--notion-serif);
      transition: background-color 0.3s ease;
      background: white;
      margin: 0;
      padding: 20px 0 0 0;  /* ✅ 20px space at the top */
      display: flex;
      flex-direction: column;
      justify-content: flex-start; /* center horizontally only */
      align-items: center; /* align items to the top */
      height: 100vh;
      box-sizing: border-box;
    }
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #191919;
      }
    }
    .container {
      background: #eef2f3;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 3px 8px #5836271A;
      display: flex;
      width: 230px;
      box-sizing: border-box;
      max-width: 95vw;
      margin: 0 auto;
      align-items: center;
      gap: 10px
    }

    #buttonsContainer {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        background: transparent;     /* transparent background */
        padding: 10px;
        box-shadow: 0 0px 0px #ffffff00;
        width: 230px;
        height: 100px;
        overflow-y: auto;          /* vertical scroll */
        box-sizing: border-box;
        }

    #confirmation {
      max-width: 95vw;
      width: fit-content;
      margin: 8px auto 0;  /* vertical spacing and center horizontally */
      font-size: 14px;
      padding: 12px;
      text-align: left;  /* or left if you prefer */
      color: black;      /* green by default, override with JS on error */
      font-family: var(--notion-serif);
      font-weight: 600;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: nowrap;
    }

    #country-select {
      font-family: var(--notion-serif);
      width: 60px;
      padding: 6px;
      border-radius: 8px;
      border: 1.5px solid #cbd5e1;
      font-size: 14px;
      background: #f7fafc;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    #country-select:focus {
      outline: none;
      border-color: #3182ce;
    }

    input[type="text"] {
      background: white;
      width: 30px;
      padding: 6px;
      font-size: 14px;
      border-radius: 8px;
      border: 1.5px solid #cbd5e1;
      text-align: center;
      font-family: var(--notion-serif);
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #3182ce;
    }

    input[type="text"].special-input {
      background: #eef2f3;
    }

    input[type="text"].normal-input {
      background: white;
    }

    .separator {
      font-size: 16px;
      font-weight: bold;
      color: #4a5568;
      transition: opacity 0.3s;
    }

    .dash-separator {
      opacity: 0.4;
    }

    .dash-filled {
      opacity: 1;
    }

    button {
      background: #526b7d;
      width: fit-content;
      border: none;
      color: white;
      padding: 6px;
      font-family: var(--notion-serif);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s;
    }

    button:hover {
      background: #202243;
    }

    .button-vbox { margin-bottom: 10px; }
</style>
</head>
<body>
<div class="container">
  <input type="text" id="refInput" placeholder="Enter references" style="width: 150px;">
  <button id="goBtn">&rArr;</button>
</div>

<div id="buttonsContainer" class="container"></div>

<script>
const lengthBook = {'Gn': 50, 'Ex': 40, 'Lv': 27, 'Nb': 36, 'Dt': 34, 'Jos': 24, 'Jg': 21, 'Rt': 4, '1S': 31, '2S': 24, '1R': 22, '2R': 25,
                    '1Ch': 29, '2Ch': 36, 'Esd': 10, 'Ne': 13, 'Tb': 14, 'Jdt': 16, 'Est': 16, '1M': 16, '2M': 15, 'Jb': 42, 'Ps': 150, 'Pr': 31,
                    'Qo': 12, 'Ct': 8, 'Sg': 19, 'Si': 51, 'Is': 66, 'Jr': 52, 'Lm': 5, 'Ba': 6, 'Ez': 48, 'Dn': 14, 'Os': 14, 'Jl': 4, 'Am': 9,
                    'Ab': 1, 'Jon': 4, 'Mi': 7, 'Na': 3, 'Ha': 3, 'So': 3, 'Ag': 2, 'Za': 14, 'Ml': 3, 'Mt': 28,
                    'Mc': 16, 'Lc': 24, 'Jn': 21, 'Ac': 28, 'Rm': 16, '1Co': 16, '2Co': 13, 'Ga': 6, 'Ep': 6, 'Ph': 4, 'Col': 4, '1Th': 5,
                    '2Th': 3, '1Tm': 6, '2Tm': 4, 'Tt': 3, 'Phm': 1, 'He': 13, 'Jc': 5, '1P': 5, '2P': 3, '1Jn': 5, '2Jn': 1, '3Jn': 1,
                    'Jude': 1, 'Ap': 22};

function extractIds(input) {
    return input.match(/[a-zA-Z]+[^a-zA-Z]*/g) || [];
}

function truncateToLastDigit(s) {
    const match = s.match(/\d(?!.*\d)/);
    return match ? s.slice(0, match.index + 1) : '';
}

function cleanLetterNumberBoundary(s) {
    const match = s.match(/^([a-zA-Z]+)[^0-9]*([0-9].*)$/);
    return match ? [match[1], match[2]] : [s, ''];
}

function removeAllSpaces(s) { return s.replace(/\s+/g,''); }
function removeUnwantedPunctuation(s) { return s.replace(/[^\w\s\-‑–—.,:;]/g,''); }
function collapseAndWarnOnMixedPunctuation(s) {
    return s.replace(/([!"#$%&'()*+,\-./:;<=>?@[\\\]^_`{|}~])\1*/g, (m, p1) => p1);
}

function splitTextToOrderedTuple(text) {
    return text.split(/[;,]+/).map(part => part.trim().split(/[:,.]+/).filter(Boolean));
}

async function makeRequest(book, ref) {
    const targetUrl = `https://www.aelf.org/bible/${book}/${ref[0]}`;
    const encodedUrl = encodeURIComponent(targetUrl);
    const proxyUrl = `https://wandering-disk-7183.victoire-monziols.workers.dev?url=${encodedUrl}`;
    console.log("Current book:", ref[0]);

    try {
        const response = await fetch(proxyUrl);
        const htmlText = await response.text();

        // Parse HTML content
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, "text/html");

        // Extract text from page
        let lines = Array.from(doc.body.innerText.split("\n")).map(l => l.trim()).filter(Boolean);

        let sections = [];
        let currentSection = [];

        for (let line of lines) {
                let stripped = line.trim();
                if (stripped) {
                    currentSection.push(stripped);
                } else if (currentSection.length > 0) {
                    sections.push(currentSection);
                    currentSection = [];
                }
            }
            if (currentSection.length > 0) {
                sections.push(currentSection);
            }

            // Pick the second-to-last section (Python's [-2])
            let section = sections.length >= 2 ? sections[sections.length - 2] : [];
            let matchingLines = [];
            let matchingLinesRaw = [];

            //if (withoutRefs) {
            for (let i = 0; i < sections[0].length; i++) {
                if (i === 0) continue; // skip first line

                let line = sections[0][i].trim();
                console.log(line)

                // Check if line starts with a number followed by a space
                if (/^\d+\s/.test(line)) {
                    // Keep everything after the first space
                    let afterSpace = line.replace(/^\d+\s/, '');
                    matchingLines.push(afterSpace);
                }
            }

            console.log(matchingLines)
            // } else {
            //     for (let line of section) {
            //         let partsRaw = line.trim();
            //         let parts = partsRaw.split(/\s+/, 2);
            //         if (parts.length < 2) continue;

            //         let num = parseInt(parts[0], 10);
            //         if (!isNaN(num) && num >= userInput2 && num <= userInput3) {
            //             matchingLines.push(parts[1]);
            //             matchingLinesRaw.push(partsRaw);
            //         }
            //     }
            // }

            // Create URL with text fragment if matchingLinesRaw exists
            if (matchingLinesRaw.length > 0) {
                let matchingPlainRaw = matchingLinesRaw[0]; // only first line
                let matchingTextRaw = encodeURIComponent(matchingPlainRaw);
                let newUrl = url + "#:~:text=" + matchingTextRaw;
                if (newUrl.length < 2000) {
                    url = newUrl;
                }
            }

        return [targetUrl, matchingLines];
    } catch (e) {
        console.error("Failed to fetch content:", e);
        return ["", ["Failed"]];
    }
}


// Copy to clipboard
function copyToClipboard(content) {
    navigator.clipboard.writeText(content).then(() => console.log("Copied!"));
}

async function launcher(rawText) {
    const container = document.getElementById('buttonsContainer');
    container.innerHTML = '';
    const ids = extractIds(rawText);
    for (let id of ids) {
        id = truncateToLastDigit(id);
        if (!id) continue;
        let [book, num] = cleanLetterNumberBoundary(id);
        book = book.charAt(0).toUpperCase() + book.slice(1);
        if (!(book in lengthBook)) continue;

        num = removeAllSpaces(num);
        num = removeUnwantedPunctuation(num);
        num = collapseAndWarnOnMixedPunctuation(num);
        let tuples = splitTextToOrderedTuple(num);

        for (let t of tuples) {
            const btn = document.createElement('button');
            const btnText = `${book} ${t.join(':')} ${String.fromCodePoint(0x1F4CB)}`;
            btn.textContent = btnText;
            btn.onclick = async () => {
                console.log("Clicked")
                const [url, text] = await makeRequest(book, t);
                copyToClipboard(`${btnText} : ${text.join(' ')}`);
            };
            const div = document.createElement('div');
            div.className = 'button-vbox';
            div.appendChild(btn);
            container.appendChild(div);
        }
    }
}

document.getElementById('goBtn').addEventListener('click', () => {
    const input = document.getElementById('refInput').value;
    launcher(input);
});
</script>

</body>
</html>
